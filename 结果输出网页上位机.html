<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PLä¿¡å·çŠ¶æ€ç›‘æ§</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI','Microsoft YaHei',sans-serif;}
body {background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;color:#fff;}
.container {width:100%;max-width:900px;background:rgba(0,0,0,0.7);border-radius:20px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.5);backdrop-filter:blur(10px);}
header {text-align:center;margin-bottom:30px;}
h1 {font-size:2.5rem;margin-bottom:10px;background:linear-gradient(to right,#ff7e5f,#feb47b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 4px rgba(0,0,0,0.3);}
.status-container {display:flex;justify-content:space-between;margin-bottom:30px;flex-wrap:wrap;gap:20px;}
.status-card {flex:1;min-width:200px;background:rgba(255,255,255,0.1);border-radius:15px;padding:20px;text-align:center;transition:transform 0.3s,box-shadow 0.3s;}
.status-card:hover {transform:translateY(-5px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.status-card h3 {font-size:1.2rem;margin-bottom:10px;color:#ddd;}
.status-value {font-size:2.5rem;font-weight:bold;}
.voice-value{color:#4CAF50;} .music-value{color:#2196F3;} .busy-value{color:#FF9800;}
.result-display{background:rgba(255,255,255,0.1);border-radius:15px;padding:30px;text-align:center;margin-bottom:20px;min-height:180px;display:flex;flex-direction:column;justify-content:center;align-items:center;}
.detection-result{font-size:3rem;font-weight:bold;margin-bottom:15px;min-height:80px;display:flex;align-items:center;justify-content:center;}
.voice-detected{color:#4CAF50;text-shadow:0 0 10px rgba(76,175,80,0.5);}
.music-detected{color:#2196F3;text-shadow:0 0 10px rgba(33,150,243,0.5);}
.no-signal{color:#9E9E9E;}
.processing{font-size:1.5rem;color:#FF9800;min-height:40px;display:flex;align-items:center;justify-content:center;}
.signal-history{background:rgba(255,255,255,0.1);border-radius:15px;padding:20px;max-height:200px;overflow-y:auto;}
.signal-history h3{text-align:center;color:#ddd;margin-bottom:15px;}
.history-list{list-style-type:none;}
.history-item{padding:8px 12px;margin-bottom:8px;background:rgba(0,0,0,0.3);border-radius:8px;display:flex;justify-content:space-between;}
.history-time{color:#aaa;font-size:0.9rem;}
.voice-event{color:#4CAF50;} .music-event{color:#2196F3;} .busy-event{color:#FF9800;}
.pulse{animation:pulse 1.5s infinite;}
@keyframes pulse{0%{opacity:1;}50%{opacity:0.7;}100%{opacity:1;}}
@media(max-width:768px){.status-container{flex-direction:column;}h1{font-size:2rem;}.detection-result{font-size:2.2rem;}}
.connect-btn {display:block;margin:0 auto 20px auto;padding:10px 20px;border:none;border-radius:10px;background:#2196F3;color:white;font-size:1rem;cursor:pointer;transition:0.3s;}
.connect-btn:hover {background:#42a5f5;}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>PLä¿¡å·çŠ¶æ€ç›‘æ§</h1>
        <p>å®æ—¶æ˜¾ç¤ºFFTå¤„ç†çŠ¶æ€</p>
    </header>

    <button class="connect-btn" id="connect-btn">ğŸ”Œ è¿æ¥ä¸²å£</button>

    <div class="status-container">
        <div class="status-card"><h3>è¯­éŸ³ä¿¡å·</h3><div class="status-value voice-value" id="voice-status">0</div></div>
        <div class="status-card"><h3>éŸ³ä¹ä¿¡å·</h3><div class="status-value music-value" id="music-status">0</div></div>
        <div class="status-card"><h3>å¤„ç†çŠ¶æ€</h3><div class="status-value busy-value" id="busy-status">0</div></div>
        <!-- å³°å€¼é¢‘ç‚¹(Index) -->
        <div class="status-card"><h3>å³°å€¼é¢‘ç‚¹ (Index)</h3><div class="status-value" id="peak-index">-</div></div>
    </div>

    <div class="result-display">
        <div class="detection-result" id="detection-result">ç­‰å¾…ä¿¡å·è¾“å…¥...</div>
        <div class="processing" id="processing-status"></div>
    </div>

    <div class="signal-history">
        <h3>ä¿¡å·å†å²è®°å½•</h3>
        <ul class="history-list" id="history-list"></ul>
    </div>
</div>

<script>
let lastVoice = 0, lastMusic = 0, lastBusy = 0;

// === ä¸²å£è¾“å…¥è¡Œè§£æ ===
function parseSerialLine(line) {
    line = line.trim();
    if (!line) return;

    let voice = 0, music = 0, busy = 0;
    let idx = null;    // index é»˜è®¤ä¸è¦†ç›–
    let maxFlag = 1;   // è‹¥æœªç»™å‡ºmaxï¼ŒæŒ‰ä½ çš„è¦æ±‚â€œæ­£å¸¸â€å¤„ç†

    // âœ… ä¼˜å…ˆè§£æ JSON æ ¼å¼
    if (line.startsWith("{") && line.endsWith("}")) {
        try {
            const data = JSON.parse(line);

            voice   = data.voice ?? 0;
            music   = data.music ?? 0;
            busy    = data.busy  ?? 0;
            maxFlag = (data.max ?? 1);

            if (typeof data.index !== "undefined") {
                const n = Number(data.index);
                if (Number.isFinite(n)) idx = n;
            }

            updateDisplay(voice, music, busy, idx, maxFlag);
            return;
        } catch (e) {
            console.warn("JSONè§£æå¤±è´¥:", e, line);
        }
    }

    // âœ… å…¼å®¹æ—§æ–‡æœ¬æ ¼å¼ï¼ˆæ²¡æœ‰max/indexï¼‰
    if (line.includes("æ£€æµ‹åˆ°è¯­éŸ³ä¿¡å·")) voice = 1;
    if (line.includes("æ£€æµ‹åˆ°éŸ³ä¹ä¿¡å·")) music = 1;
    if (line.includes("FFTing") || /Busy:\s*1/.test(line)) busy = 1;

    updateDisplay(voice, music, busy, null, 1);
}

// === æ›´æ–°UIæ˜¾ç¤º ===
function updateDisplay(voiceState, musicState, busyState, peakIndex, maxFlag) {
    // æ›´æ–°æ•°å€¼åŒº
    document.getElementById('voice-status').textContent = voiceState;
    document.getElementById('music-status').textContent = musicState;
    document.getElementById('busy-status').textContent  = busyState;

    const detectionResult  = document.getElementById('detection-result');
    const processingStatus = document.getElementById('processing-status');
    const peakIndexEl      = document.getElementById('peak-index');

    // BusyçŠ¶æ€åŠ¨ç”»ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
    if (busyState) {
        processingStatus.textContent = "æ­£åœ¨æ£€æµ‹ä¸­...";
        processingStatus.classList.add('pulse');
    } else {
        processingStatus.textContent = "";
        processingStatus.classList.remove('pulse');
    }

    // === å³°å€¼é¢‘ç‚¹æ˜¾ç¤ºï¼šmax=0 æ—¶ index æ— æ•ˆï¼Œç”¨ "--" ===
    if (maxFlag === 0) {
        peakIndexEl.textContent = "--";
    } else if (Number.isFinite(peakIndex)) {
        peakIndexEl.textContent = peakIndex;
    }
    //ï¼ˆå½“ max=1 ä½†æœ¬æ¬¡æ²¡æœ‰æ–° index æ—¶ï¼Œä¸æ”¹åŠ¨æ˜¾ç¤ºï¼‰

    // === å¤§å­—ä¸»æ˜¾ç¤ºï¼šå…ˆæŒ‰åŸé€»è¾‘æ›´æ–°ï¼ˆä»…åœ¨è¯­éŸ³/éŸ³ä¹å˜åŒ–æ—¶ï¼‰===
    let newState = "";
    if (voiceState) newState = "è¯­éŸ³ä¿¡å·";
    else if (musicState) newState = "éŸ³ä¹ä¿¡å·";
    else newState = "æ— ä¿¡å·";

    if (voiceState !== lastVoice || musicState !== lastMusic) {
        if (voiceState) {
            detectionResult.textContent = "æ£€æµ‹åˆ°è¯­éŸ³ä¿¡å·";
            detectionResult.className   = "detection-result voice-detected pulse";
            addHistoryEvent("è¯­éŸ³ä¿¡å·");
        } else if (musicState) {
            detectionResult.textContent = "æ£€æµ‹åˆ°éŸ³ä¹ä¿¡å·";
            detectionResult.className   = "detection-result music-detected pulse";
            addHistoryEvent("éŸ³ä¹ä¿¡å·");
        } else if (busyState) {
            detectionResult.textContent = "æœªæ£€æµ‹åˆ°ä¿¡å·";
            detectionResult.className   = "detection-result no-signal";
        }
    }

    // === max é—¨æ§ï¼šmax=0 æ—¶å¼ºåˆ¶è¦†ç›–ä¸ºâ€œæœªæ£€æµ‹åˆ°å£°éŸ³â€ ===
    if (maxFlag === 0) {
        detectionResult.textContent = "æœªæ£€æµ‹åˆ°å£°éŸ³";
        detectionResult.className   = "detection-result no-signal";
        // æ³¨æ„ï¼šä¸å†™å†å²è®°å½•ï¼Œä¿æŒåŸæ¥çš„â€œåªåœ¨è¯­éŸ³/éŸ³ä¹çŠ¶æ€å˜åŒ–æ—¶è®°å½•â€çš„ç­–ç•¥
    }

    lastVoice = voiceState;
    lastMusic = musicState;
    lastBusy  = busyState;
}

// === å†å²è®°å½• ===
function addHistoryEvent(eventType) {
    const historyList = document.getElementById('history-list');
    const now = new Date();
    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
    const listItem = document.createElement('li');
    listItem.className = 'history-item';
    let eventClass = eventType === 'è¯­éŸ³ä¿¡å·' ? 'voice-event' : (eventType === 'éŸ³ä¹ä¿¡å·' ? 'music-event' : 'busy-event');
    listItem.innerHTML = `<span class="history-time">${timeString}</span><span class="history-event ${eventClass}">${eventType}</span>`;
    historyList.insertBefore(listItem, historyList.firstChild);
    if (historyList.children.length > 10) historyList.removeChild(historyList.lastChild);
}

// === ä¸²å£è¿æ¥ ===
const connectBtn = document.getElementById('connect-btn');
let port, reader;

connectBtn.addEventListener('click', async () => {
    try {
        if (!("serial" in navigator)) {
            alert("âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Serial APIï¼Œè¯·ä½¿ç”¨ Chrome 89+ æˆ– Edgeã€‚");
            return;
        }
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        connectBtn.textContent = "âœ… ä¸²å£å·²è¿æ¥";
        listenToPort();
    } catch (err) {
        alert("ä¸²å£è¿æ¥å¤±è´¥ï¼š" + err);
    }
});

async function listenToPort() {
    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();

    let buffer = "";
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) {
            buffer += value;
            const lines = buffer.split(/\r?\n/);
            buffer = lines.pop();
            for (const line of lines) parseSerialLine(line);
        }
    }
}
</script>
</body>
</html>
